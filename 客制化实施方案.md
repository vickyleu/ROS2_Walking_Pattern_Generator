## 客制化步态与外观实施方案

> **适用对象**：自有玩具/机器人 IP，需要在本项目（ROS2_Walking_Pattern_Generator）基础上实现定制外观与步态控制的团队。  
> **目标**：给出从需求定义到落地量产的全流程指南，包含所需技术、工具、交付物与关键检查点。

---

### 1. 总体时间线与角色分工

| 阶段 | 主要目标 | 参与角色 | 关键输出 |
| --- | --- | --- | --- |
| 0. 需求澄清 | 锁定功能/外观/成本/交期 | 产品、工业设计、控制算法负责人 | 需求说明书、功能列表、预算 |
| 1. 外观工业设计 | 定稿造型与材质 | 工业设计、CMF、结构工程 | 概念稿、3D 模型、色板 |
| 2. 机械结构&材料 | 确认骨架、传动、壳件 | 结构工程、供应链 | 零件 BOM、装配图、FMEA |
| 3. 电子与传感 | 传感器/执行器布局 | 硬件工程、嵌入式开发 | 电子 BOM、接口文档、原理图 |
| 4. 控制软件 | 步态、控制参数、接口 | 控制算法、ROS 工程师 | 参数文件、插件代码、测试用例 |
| 5. 仿真验证 | 虚拟调试+可视化 | 控制、仿真工程 | Webots 世界、RViz 配置、记录数据 |
| 6. 实机调试 | 联调、校准、测试 | 全栈团队 | 调试报告、标定数据、QA 用例 |
| 7. 量产 & 维护 | 版本封版、资料归档 | 产品、运营、售后 | MRD、量产包、维护策略 |

---

### 2. 阶段 0：需求澄清（1~2 周）

1. **功能列表**：行走速度、转向角速度、步态类型（走/跑/踢腿等）。  
2. **外观要求**：身高、躯干/四肢比例、配色、材质（塑料/金属/织物）。  
3. **约束条件**：电池容量、成本上限、儿童玩具安全标准（如 EN71）。  
4. **交付定义**：需提供 Demo 机或量产？是否开放 SDK？  
5. **技术基线**：是否沿用 Webots/ROS2 Jazzy；是否需要兼容现有 App。

> 建议输出《需求说明书》+《风险清单》，并在 Confluence/Git 仓库归档。

---

### 3. 阶段 1：外观 & 工业设计（3~4 周）

1. **参考技术**  
   - 概念绘制：Procreate、Photoshop。  
   - 3D 建模：Blender（免费）、Maya、SolidWorks（机械）。  
   - CMF 材质：Substance Painter、Keyshot 渲染。  
2. **流程**  
   1. 概念草图 → 立体结构拆分 → 骨架/壳件装配关系。  
   2. 输出低模（Low Poly）用于实时渲染，高模（High Poly）用于渲染/3D 打印。  
   3. 导出格式：`*.blend` → `*.fbx`/`*.dae` → `*.stl`（Webots 需要）。  
3. **与项目的对接**  
   - 在 `robot_description/models/<toy_name>/meshes/` 放置定制 `STL`。  
   - 更新 `robot_description/models/<toy_name>/proto/<toy_name>.proto` 以及 `urdf`。  
   - 使用 `robot_tools/model_parameter_generator.py` 根据新的 URDF 生成参数 YAML。

---

### 4. 阶段 2：机械结构与材料（2~3 周）

1. **骨架设计**：根据步态需要，确定关节 DOF 与行程。推荐用 SolidWorks/Creo。  
2. **材料选择**：壳体（ABS/PC）、骨架（铝/碳纤维）、关节（3D 打印 + 金属内芯）。  
3. **驱动与减速**：依据目标扭矩选择 Servo/BLDC + 行星减速器。  
4. **装配验证**：利用 `robot_description/models/<toy_name>/parts_properties.md` 记录重量、惯量。  
5. **输出**：BOM、装配图、关键零件 2D 工程图。

---

### 5. 阶段 3：电子与传感

1. **传感器配置**：IMU、关节编码器、压力/触摸开关。  
2. **控制板**：可选 STM32H7 / Teensy4.1 / 定制板；需要与 ROS2 桥接（micro-ROS 或 CANopen）。  
3. **供电**：根据扭矩与续航算电池规格；注意玩具法规（UN38.3）。  
4. **通信协议**：推荐 ROS2 ↔ MCU 使用 `ros2_control` + `ros2_control_hardware_interface`，或定制 `robot_manager` 内的 `rclcpp::Publisher`/`Subscription`。  
5. **接口文档**：定义消息类型（可扩展 `robot_messages/msg/*.msg`）。  

---

### 6. 阶段 4：控制软件客制化

#### 6.1 参数服务器

- 文件：`robot_bringup/config/param_control.yaml`、`param_robot_description.yaml`。  
- 调整项：  
  - `control_times.control_cycle`（默认 0.01s）  
  - `walking_cycle`、`both_leg_support_period`（步态节奏）  
  - `control_constant.waist_pos_z`（身高变化）  
  - 自定义机器人名：`robot_description.robot_name = toy_alpha`，并在同名目录下放置 limb 参数。

#### 6.2 足部规划 Foot Step Planner

- 文件：`foot_step_planner/src/FootStepPlanner.cpp`。  
- 建议将硬编码的 `foot_pos` 替换为加载 YAML（新增 `foot_step_planner/config/toy_alpha.yaml`）。  
- 技术：使用 `rclcpp::SyncParametersClient` 读取步长/步宽/转弯策略。  
- 扩展：可引入 Bézier 曲线或样条函数，实现曲线行走。

#### 6.3 步态生成 Walking Pattern Generator（LIPM）

- 文件：`walking_pattern_generator/src/LinearInvertedPendulumModel.cpp`。  
- 关键参数：`WAIST_POS_Z_`、`CONTROL_CYCLE_`、`WALKING_CYCLE_`。  
- 若玩具身高变化，需要重新计算 `T_c = sqrt(waist_z / 9.81)`。  
- 可扩展：  
  - 添加外部推力补偿 → 引入实时 CoG 反馈（IMU + Kalman）。  
  - 如果需要跑步，可将 `T_sup` 缩短，并加入 `preview control`。

#### 6.4 稳定控制 Walking Stabilization Controller

- 默认实现仅转发，可自定义：  
  - 引入 ZMP 反馈控制（基于 `LQR` 或 `MPC`）。  
  - 接入力传感器：在 `walking_stabilization_controller/src/WalkingStabilizationController.cpp` 内读取订阅话题，动态修正 `zmp_pos_fix`。

#### 6.5 关节轨迹 Convert To Joint States

- 文件：`convert_to_joint_states/src/ConvertToJointStates.cpp`。  
- 步骤：  
  1. 更新 `LEFT_LEG_UNIT_VECTOR_STRING_` / `RIGHT_LEG_UNIT_VECTOR_STRING_`（参数 YAML）。  
  2. 设置新的 `link_length`（来自 CAD）。  
  3. 调整 `HEIGHT_LEG_LIFT_`、`BOTH_LEG_SUPPORT_PERIOD_` 以符合玩具步态。  
- 技术：  
  - IK/雅可比模块来自 `kinematics` 插件，可替换为自研 Solver（如 `Levenberg-Marquardt`）。  
  - 若关节超过 6 DOF，需要扩展数据结构（`std::array<double, 6>` → `std::vector<double>`）。

#### 6.6 Robot Manager 协调

- 文件：`robot_manager/src/robot_manager.cpp`。  
- 任务：  
  - 根据模式（离线/在线）调用各插件。  
  - `pub_joint_states_` → `/joint_states`，用于 RViz / Webots。  
  - Debug 模式：记录 `Records/` 内的数据，供离线分析。  
- 自定义点：  
  - 可新增 REST/gRPC 接口，动态下发步态命令。  
  - 若使用自研硬件，可将 `rclcpp::Publisher<sensor_msgs::msg::JointState>` 改为自定义消息。

---

### 7. 阶段 5：仿真验证

1. **仿真环境**：Webots R2025a + `webots_robot_handler`。  
2. **外观同步**：在 `webots_robot_handler/resource/webots_robotis_op2_description.urdf` 基础上换成玩具 URDF/PROTO。  
3. **场景搭建**：`webots_robot_handler/worlds/<toy_demo>.wbt`，加入地面材料、障碍物。  
4. **可视化**：  
   - RViz（`robot_visualizer/rviz/display.rviz`）查看 `/joint_states`。  
   - MatPlotLib/MATLAB（`Records/plot_programs/matlab_plot.m`）分析 CoG/ZMP。  
5. **自动化测试**：  
   - 通过 `ros2 launch robot_bringup robot_bringup_launch.py debug:=true` 启动。  
   - 使用 `robot_recorder` 记录数据，对比期望曲线。

---

### 8. 阶段 6：实机调试

1. **装配检查**：按照机械装配图核对间隙，确保舵机零位一致。  
2. **传感器标定**：IMU 静态/动态标定，关节编码器零点写入参数服务器。  
3. **闭环验证**：  
   - 先在支架上悬空测试，确认关节方向与约束。  
   - 再进行慢速步态 → 正常步速 → 扰动测试。  
4. **安全策略**：  
   - 设定 `/emergency_stop` Topic，必要时断电。  
   - 监控电池温度、电流。  
5. **调试记录**：使用 `robot_recorder` 记录全流程，归档到 `Records/<date>/`。

---

### 9. 阶段 7：量产与维护

1. **版本封版**：Git tag（如 `toy-alpha-v1.0`），导出 `colcon build` 产物。  
2. **量产包**：提供 `URDF/PROTO/STL`、参数 YAML、控制软件版本、测试报告。  
3. **维护策略**：  
   - 建立参数管理表，避免现场修改未回写仓库。  
   - 制定例行巡检（关节松动、传感器漂移）。  
   - 若开放 SDK，提供 `ros2 pkg create toy_alpha_sdk` 示例。

---

### 10. 关键技术清单

| 场景 | 技术 / 工具 | 备注 |
| --- | --- | --- |
| 外观建模 | Blender / ZBrush / Substance Painter | 输出 STL/FBX |
| 结构设计 | SolidWorks / Creo / Onshape | 输出 STEP、质量属性 |
| 仿真 | Webots R2025a / Gazebo Harmonic | Webots 已集成，Gazebo 可选 |
| 控制 | ROS 2 Jazzy + rclcpp + pluginlib | 本项目基于此栈 |
| 运动学 | Eigen3、IK/TF Solver | 已封装在 `kinematics` 包 |
| 数据记录 | robot_recorder、ROS 2 bag | Debug 模式下使用 |
| 可视化 | RViz2、Matlab、PlotJuggler | 分析 CoG/ZMP/关节曲线 |
| 实机接口 | ros2_control、自研 CAN/RS485 驱动 | 视硬件而定 |
| 版本管理 | Git + Git LFS（大模型文件） | 建议启用 LFS 保存 STL |

---

### 11. 建议的交付物结构

```
toy_alpha_delivery/
  ├── README.md                 # 项目概述与快速开始
  ├── CAD/                      # STEP、装配图
  ├── meshes/                   # STL/FBX
  ├── urdf_proto/               # URDF + PROTO
  ├── ros2_ws/                  # 定制代码
  │   └── src/ROS2_Walking_Pattern_Generator/...
  ├── configs/
  │   ├── param_control.yaml
  │   └── foot_step_profiles.yaml
  ├── tests/
  │   ├── simulation_report.md
  │   └── hardware_test_report.md
  └── docs/
      ├── 需求说明书.pdf
      ├── 风险与对策.xlsx
      └── 维护手册.md
```

---

### 12. 里程碑检查清单

1. **Kick-off**：需求文档评审通过。  
2. **ID 冻结**：工业设计 + CMF 确认、3D 模型归档。  
3. **EV 样机**：机械/电子样机完成，步态 Demo 在仿真中可运行 1 分钟无误。  
4. **DV 样机**：实机行走 10 分钟稳定，外观件通过跌落/耐磨测试。  
5. **PV 小批量**：产线 SOP + 质检流程走通。  
6. **量产交付**：用户验收通过，维护团队接管。

---

### 13. 后续可扩展方向

- **情感互动**：加入头部/上肢动作，扩展 `convert_to_joint_states` 支持全身 IK。  
- **AI 行为**：结合语音识别（如 Riva）、视觉（如 YOLOv8），通过 ROS2 动作接口触发不同步态。  
- **多玩具协作**：在 `robot_manager` 上层加入编队控制（多节点通信，使用 DDS QoS 调优）。  
- **移动 App**：提供 BLE/Wi-Fi 控制面板，利用 ROS2-web-bridge / micro-ROS 进行遥控。

---

如需针对某一步骤的 SOP、脚本或培训材料，可继续细化。建议在 Git 仓库的 `docs/` 目录建立对应章节，确保设计、代码、参数三端一致。祝定制顺利。🦾


